---
# file: roles/fluentd/tasks/main.yml
# See: http://docs.fluentd.org/articles/install-by-rpm
- name: install ntp, libcurl-devel
  sudo: yes
  yum: pkg={{ item }} state=installed
  tags: fluentd
  with_items:
    - ntp
    - libcurl-devel

- name: download install script.
  sudo: yes
  get_url: >
      url={{ item.install_script_url }}
      dest={{ item.download_dest_dir }}
  with_items:
    fluentd
  tags: fluentd

- name: install fluentd.
  sudo: yes
  command:
    sh {{ item.download_dest_dir }}/{{ item.install_script }}
  with_items:
    fluentd
  tags: fluentd

- name: mkdir /var/lib/fluent
  sudo: yes
  file: >
    path={{ item.pos_file_dir }}
    state=directory
    owner=td-agent
    group=td-agent
    mode=0755
  with_items:
    fluentd
  tags: fluentd

- name: create pos_file.
  sudo: yes
  file: >
    path={{ item.pos_file_dir }}/{{ item.nginx_pos_file }}
    state=file
    owner=td-agent
    group=td-agent
  with_items:
    fluentd
  tags: fluentd

- name: put td-agent.conf.
  sudo: yes
  template: >
    src={{ item.conf_src }}
    dest={{ item.conf_dest }}
  with_items:
    fluentd
  tags: fluentd
